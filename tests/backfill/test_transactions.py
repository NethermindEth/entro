import json

from nethermind.entro.decoding import DecodingDispatcher
from nethermind.entro.backfill.etherscan import (
    _parse_etherscan_transactions,
    _trim_last_block,
)
from nethermind.entro.types.backfill import SupportedNetwork


class TestEtherscan:
    def test_parse_transaction(self):
        # fmt: off
        raw_json = '[{"blockNumber":"13681875","timeStamp":"1637821087","hash":"0xbccf9b3b78ac68fa5633c5f8d6457736fc44e54f1b9623866b1cd2666bac2ee7","nonce":"97","blockHash":"0x964265266d4f5d9d668a5eaaa5faa46d49e5586f051d58a338b6c3b7693f774a","transactionIndex":"56","from":"0x2c169dfe5fbba12957bdd0ba47d9cedbfe260ca7","to":"0xc662c410c0ecf747543f5ba90660f6abebd9c8c4","value":"0","gas":"4500000","gasPrice":"153546032089","isError":"0","txreceipt_status":"1","input":"0x13f4a5b600000000000000000000000000000000000000000000000000000000000000610000000000000000000000000000000000000000000000000000000000000080629de5980cd6edd3f34c3263c0379915742a67f1389e9d544d02d03832c7b49b00000000000000000000000000000000000000000000000000000000000000e4000000000000000000000000000000000000000000000000000000000000004a01e84643c15f0b2c2c8d4678d4454b9f217e8a71b4beff558f3ead5ae1f4381002714f8b9546fc722d1b99812fb18f45cbd47646e0f205af41122dcd25b900bf0000000000000000000000000000000000000000000000000000000000000046000b3a5401287755eef65a2ec212b30066d14c31c8a62f94da6d931043b96de800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022000b3a5401287755eef65a2ec212b30066d14c31c8a62f94da6d931043b96de800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000220552f54c605c6463c6f6498f3ab9e225ceaf557b06100481312396de02454c6b00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000220552f54c605c6463c6f6498f3ab9e225ceaf557b06100481312396de02454c6b00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022017daeb497b6fe0f7adaa32b44677c3a9712b6856b792ad993fcef20aed21ac80000000000000000000000005e7cc6b2c9a8250db7bb984cca68ff7ccaede3590000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002203dfe71252946ca2754fb9f5fe0e0f32156f31f787593bc530cb27bf16d3fc64000000000000000000000000f38eba7f3d2ca3f61fdab519f78fe4f1aa55d7a30000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002203dfe71252946ca2754fb9f5fe0e0f32156f31f787593bc530cb27bf16d3fc6400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000220358b81634a8b00b1ed821b60b8ab4796d6e700e2ee4a2ddfbd0aba28d45849f00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000220726c976630fb2e6c7716ceb5610f2f0b7f0a7d97654a8505cf9122f1fd72679000000000000000000000000260bdec22efb5b17c4dee9dbe94c0dedf8d6ddb00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002206dd2bdc97b37b7997ce9353580d6050ae2a9d2649ad2f4cbf8356bf0ddfd65d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002205d6b8d5fd22e1b64304bf82b02e7067c61e96d78848a6ecd651d9b59ee109e300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002205d6b8d5fd22e1b64304bf82b02e7067c61e96d78848a6ecd651d9b59ee109e300000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002205ad0e5739d3a84a78aa1f39be7e552dbb5906d83e82f9f1a9748b7ae7d20a3a000000000000000000000000bfcf1e7b1c0c4eebe988dbd2defa7a1c8a1c9bad0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002200dea44f6b739ddb9ef89d839d01ffe28b98bf3ac045023896ac68b54abf83de00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000","contractAddress":"","cumulativeGasUsed":"5612560","gasUsed":"399251","confirmations":"4227511","methodId":"0x13f4a5b6","functionName":"updateState(int256 sequenceNumber, uint256[] programOutput, uint256 onchainDataHash, uint256 onchainDataSize)"},{"blockNumber":"13681877","timeStamp":"1637821108","hash":"0x9c17c3aae7b4d92a42e540e2cf7d638cc0ae1344e1f19fc311a07d642cbfdbb4","nonce":"98","blockHash":"0x7cfae7e06b583108fa1e8f5bde7e88281a84709de40c1df81e2541cd84963c9f","transactionIndex":"250","from":"0x2c169dfe5fbba12957bdd0ba47d9cedbfe260ca7","to":"0xc662c410c0ecf747543f5ba90660f6abebd9c8c4","value":"0","gas":"4500000","gasPrice":"134806590560","isError":"0","txreceipt_status":"1","input":"0x13f4a5b600000000000000000000000000000000000000000000000000000000000000620000000000000000000000000000000000000000000000000000000000000080e20fab31dc3c698799572285eb84649e9a809bd86adbf9e089e1e73696fad930000000000000000000000000000000000000000000000000000000000000008e000000000000000000000000000000000000000000000000000000000000004a02714f8b9546fc722d1b99812fb18f45cbd47646e0f205af41122dcd25b900bf0714c7a9173556ff848dc588ebca11bdfea6acc46d0edcc9aba590a64e8d555c000000000000000000000000000000000000000000000000000000000000004600a2b4cf8877786615baace3d24e26f257bc3436bd31446018e133570c5b8e630000000000000000000000006edd8c28ff3c168c1346925c0c28a54abcfbd1ab0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022035bd12e2942ff9b926c1ce190177bb26fbe99ae2529ead49b42a1ff5c95d21000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022059b4c7716d17fb48edc0f4008b45e1412835f83c953599c4b002e314727ed3c0000000000000000000000007fc3d30c506cd5f95b196cdcfda9ebff3cf207080000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022078972ffd3d27e268c99a4a7e97b2e0881c292e0d909c98bf219ee9b65d80fe400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002200dcbc86dd6fe1614d581687d5880ffa8bc911bd3e5de28ab4e4c94f0257bb87000000000000000000000000807adb4ffe0c6ca82e8ab2cbdcf8bed9b4a1ec0f0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022017daeb497b6fe0f7adaa32b44677c3a9712b6856b792ad993fcef20aed21ac80000000000000000000000004ad585db172f5a9a9c4f2be1cd9ebdcea387064f0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000220358b81634a8b00b1ed821b60b8ab4796d6e700e2ee4a2ddfbd0aba28d45849f000000000000000000000000a301e5ff4ede5ac08dd8f28dbedd5b7cfecf2f3e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022059b4c7716d17fb48edc0f4008b45e1412835f83c953599c4b002e314727ed3c00000000000000000000000078ceb96938c8e2eeb4e3d5827ba6c56579ca5cfd0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002202b2d94478a598497ff029fae753acba33627e9ac2755abf3be4a2ae298a7a94000000000000000000000000e8931dbe4f9ef5e9d06f51fafb2d50ede730ab2c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002205ad0e5739d3a84a78aa1f39be7e552dbb5906d83e82f9f1a9748b7ae7d20a3a0000000000000000000000007e1e2c0da2d8feb6d8356a51cd668e43cb2604270000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000220358b81634a8b00b1ed821b60b8ab4796d6e700e2ee4a2ddfbd0aba28d45849f00000000000000000000000063148d974a67f02ffcfa36ed94bdf4ab04cc3fdd0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022059b4c7716d17fb48edc0f4008b45e1412835f83c953599c4b002e314727ed3c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022078972ffd3d27e268c99a4a7e97b2e0881c292e0d909c98bf219ee9b65d80fe4000000000000000000000000de6687413bfbc1a9d8bf63ccb9136ae1aae3c1a30000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000022026bf780136e466e518c4967b49427166e7f15852827d2094b6d377d7618c6550000000000000000000000001cc4d39f0de7eed14cdda6e5afb5fcb2a6aab43e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000","contractAddress":"","cumulativeGasUsed":"17173199","gasUsed":"452147","confirmations":"4227509","methodId":"0x13f4a5b6","functionName":"updateState(int256 sequenceNumber, uint256[] programOutput, uint256 onchainDataHash, uint256 onchainDataSize)"}]'

        # fmt: on
        tx_data = json.loads(raw_json)
        transactions = _parse_etherscan_transactions(
            SupportedNetwork.ethereum, tx_data, "postgresql", DecodingDispatcher()
        )

        assert len(transactions) == 2
        assert transactions[0].block_number == 13681875

        print(transactions[0])
        print(transactions[1])

    def test_trim_last_block(self):
        blocks = [
            {"blockNumber": "13681875"},
            {"blockNumber": "13681876"},
            {"blockNumber": "13681877"},
            {"blockNumber": "13681878"},
            {"blockNumber": "13681878"},
            {"blockNumber": "13681879"},
            {"blockNumber": "13681879"},
            {"blockNumber": "13681879"},
            {"blockNumber": "13681879"},
            {"blockNumber": "13681879"},
        ]

        trimmed_blocks = _trim_last_block(blocks)
        assert trimmed_blocks[-1]["blockNumber"] == "13681878"
        assert len(trimmed_blocks) == 5

        trimmed_blocks_2 = _trim_last_block(blocks + [{"blockNumber": "13681880"}])
        assert trimmed_blocks_2[-1]["blockNumber"] == "13681879"
        assert len(trimmed_blocks_2) == 10

        trimmed_blocks_3 = _trim_last_block(blocks + [{"blockNumber": "13681890"}, {"blockNumber": "13681890"}])
        assert trimmed_blocks_3[-1]["blockNumber"] == "13681879"
        assert len(trimmed_blocks_3) == 10
